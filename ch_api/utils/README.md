## The `companies-house-api/utils/` folder.

This folder contains the the modules which support the building blocks of the pipeline, namely: 

- connecting to the CH API to query for JSON resources;
- walking the JSON resource and insert the data in PostgreSQL tables;
- the command line interface to run the pipeline from the command line. 

#### The file structure
```textmate
.
├── api_functions.py
├── api_key
├── cli.py
├── helpers.py
├── json_getter.py
├── json_inserter.py
├── json_params.py
├── README.md
├── requirements.txt
├── tests
│   ├── api_functions_test.py
│   ├── helpers_test.py
│   ├── json_getter_test.py
│   └── json_inserter_test.py
└── utils_constants.py
```

`api_functions.py` contains all the supporting functions to query the API. 
It is built using [backoff](https://github.com/litl/backoff) 
and [requests](https://requests.readthedocs.io/en/master/). 

`api_key.py` stores the key generated by the 
[registration](https://developer.companieshouse.gov.uk/developer/applications/register) to CH API.

`cli` contains the code for the flags that can be passed through the command line to `prog.py` and a list of functions 
used to check for illegal cases, they are imported and used in `prog.py`.

`helpers.py` contains functions used throughout the modules which support data manipulation.

`json_getter.py` is the module used to dispatch the right url to the the `requests.get(url, ...)` method. The module 
is built using the [factory method pattern](https://realpython.com/factory-method-python/). <br /> 
The API allows for pagination by changing the value of start_index in the url: <br /> 

`...?items_per_page=XXX&start_index=XXX...` <br />

Considering that the value of `items_per_page` changes depending on the resources, the way pagination was implemented 
was through the following logic in the `@paginate` decorator.

```textmate
for start_index in range(0, items_per_page * total_pages, items_per_page):
    # compose the url 
    # do the querying
```

To build the decorator inside a class, a private inner `_Decorator` class was created to solve the problem that 
functions can’t be simple class attributes in Python, 
see [this Medium blog](https://medium.com/@vadimpushtaev/decorator-inside-python-class-1e74d23107f6).

`json_inserter.py` is the module used to walk through the JSON tree, prune and insert its leaves in separate tables 
and iterate over its array to insert the elements of the array in its table. <br /> **Note** that this module is built 
so that if a record is already present in the table, it will be overwritten.  

`json_params.py` this file contains the parameters used by `json_getter` and `json_inserter` to query, unpack and 
insert the JSON resources returned by the API. 

`README.md` this readme. 

`requirements.txt` the requirements file. 

#### JSON are unpacked recursively and the nested structure is mirrored in the tables the data is inserted to.

The JSON resources returned by the CH API are all unpacked using the `unpack()` method of the `res_inserter.Inserter()` 
class. 

The logic of the `unpack` method is quite simple: the object is peeled from the outer data inwards, every step towards the
inner most data unpack encounters a nested array or a nested hash and it inserts them in different tables. 

Here's a step by step explaination:

* 1: flatten the data excluding the keys of nested leaves and arrays;  
* 2: insert flattened data in table;  
* 3: pluck nested leaves data from the JSON and inserts them in separate tables;  
* 4: pluck nested array data from the JSON and:  
  * if the array contains a list of dictionaries:  
     * recursively call `unpack` until there is no data left.  
   * if the array contains a list of atoms (string or digit):  
     * it performs a bulk insert of the elements to a table.  
   * if the array contains a list of lists:  
     * it throws an error (edge case - would need an extra branch).  
    
To know more about how the `json_inserter` modules works with the `json_param` dictionary and how to create one step-by-step
see the [wikipage](https://github.com/Transparency-International-UK/companies-house-api/wiki/How-to-write-the-a-parameter-dictionary-to-be-able-to-use-the-json_inserter-module)
